@page "/speech"
@using FastVocab.BlazorWebApp.Pages.Speechs
@inject TextToSpeechHepler SpeakService

<h3>🔊 Phát âm từ vựng</h3>

<Input @bind-Value=_word Placeholder="Nhập từ..." />
<Button OnClick="Speak">Phát</Button>
<Button OnClick="Pause">Tạm dừng</Button>
<Button OnClick="Resume">Tiếp tục</Button>
<Button OnClick="Stop">Dừng</Button>

<hr />

<select @bind="SelectedVoice">
    <option value="">(Giọng mặc định)</option>
    @foreach (var v in Voices)
    {
        <option value="@v.Name">@v.Name (@v.Lang)</option>
    }
</select>

<div>
    <label>Tốc độ:</label>
    <input type="range" min="0.5" max="2" step="0.1" @bind="Rate" />
    <span>@Rate</span>
</div>

<SpeechButton Text="@_word" />

<hr/>
<SpeechToText></SpeechToText>

@code {
    private string _word = "example";
    private List<SpeechVoice> Voices = new();
    private string? SelectedVoice;
    private double Rate = 1.0;
    private bool _loaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ✅ Gọi JS Interop ở đây (chỉ sau khi render lần đầu)
            Voices = await SpeakService.GetVoicesAsync();
            _loaded = true;
            StateHasChanged();
        }
    }

    private async Task Speak()
    {
        if (!_loaded) return;

        await SpeakService.SpeakAsync(_word, "en-US", Rate, SelectedVoice);
    }

    private async Task Pause() => await SpeakService.PauseAsync();
    private async Task Resume() => await SpeakService.ResumeAsync();
    private async Task Stop() => await SpeakService.StopAsync();
}
